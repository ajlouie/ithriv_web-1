<div class="mat-typography dataset">
  <div
    *ngIf="dataset"
    fxLayout="row"
    fxLayout.xs="column"
    fxLayoutWrap
    fxLayoutGap="1em"
    fxLayoutAlign="center"
  >
    <div
      fxFlex.xl="75%"
      fxFlex.lg="75%"
      fxFlex.md="75%"
      fxFlex.sm="50%"
      fxFlex.xs="100%"
    >
      <mat-card>
        <mat-card-content>
          <mat-toolbar>
            <button
              *ngIf="user && dataset.can_update_meta === true"
              matTooltip="Click here to edit dataset details/permissions"
              mat-raised-button
              color="warn"
              (click)="showDataset()"
            >
              <mat-icon>
                edit
              </mat-icon>
              EDIT DATASET DETAILS
            </button>
            <span class="ithriv-spacer"></span>
            <div matTooltip="Click here to upload latest dataset file">
              <app-commons-file-upload
                *ngIf="
                  user && dataset.id !== '' && dataset.can_upload_data === true
                "
                (complete)="onFileComplete($event)"
                [target]="uploadUrl()"
                [user]="user"
                text="UPLOAD FILE"
                color="primary"
              ></app-commons-file-upload>
            </div>
            <a
              *ngIf="
                (!dataset.private || user) &&
                dataset.url !== '' &&
                dataset.can_download_data === true
              "
              (click)="cas.downloadFile(dataset.url, dataset.filename, user)"
            >
              <button type="button" mat-raised-button color="primary">
                <mat-icon
                  matTooltip="Click here to download latest dataset file ({{
                    dataset.filename
                  }})"
                >
                  file_download
                </mat-icon>
                DOWNLOAD FILE
              </button>
            </a>
          </mat-toolbar>
          <h4>
            <markdown [data]="dataset.description"></markdown>
          </h4>
          <mat-list  *ngIf="user && dataset.can_update_meta === true && dataset.dataset_type === 'DICOM'" dense>
            <mat-list-item>
              <h4 mat-line>Deidentified:</h4>
              <p mat-line>{{ dataset.dicom_de_identified }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Bids Structure:</h4>
              <p mat-line>{{ dataset.dicom_bids_structure }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Quality:</h4>
              <p mat-line>{{ dataset.dicom_quality }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Study Date:</h4>
              <p mat-line>{{ dataset.dicom_study_date }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Scanner Manufacturer Name:</h4>
              <p mat-line>{{ dataset.dicom_scanner_manufacturer_name }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Scanner Model Name:</h4>
              <p mat-line>{{ dataset.dicom_scanner_model_name }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Organ Name:</h4>
              <p mat-line>{{ dataset.dicom_organ_name }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Field of View:</h4>
              <p mat-line>{{ dataset.dicom_fieldof_view }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Field Strength:</h4>
              <p mat-line>{{ dataset.dicom_field_strength }}</p>
            </mat-list-item>
          </mat-list>
          <mat-list  *ngIf="user && dataset.can_update_meta === true && dataset.dataset_type === 'REDCap'" dense>
            <mat-list-item>
              <h4 mat-line>Project URL:</h4>
              <p mat-line>{{ dataset.redcap_project_url }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Extract Data:</h4>
              <p mat-line>{{ dataset.redcap_extract_data }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Refresh Rate:</h4>
              <p mat-line>{{ dataset.redcap_refresh_rate }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Report ID:</h4>
              <p mat-line>{{ dataset.redcap_report_id }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Project Token:</h4>
              <p mat-line>{{ dataset.redcap_project_token }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Project Title:</h4>
              <p mat-line>{{ dataset.redcap_project_title }}</p>
            </mat-list-item>
            <mat-list-item>
              <h4 mat-line>Project PI:</h4>
              <p mat-line>{{ dataset.redcap_project_pi }}</p>
            </mat-list-item>
          </mat-list>
        </mat-card-content>
      </mat-card>
      <!--
      <ejs-spreadsheet [saveUrl]="uploadUrl()" [openUrl]="dataset.url" allowSave='true'> 
      </ejs-spreadsheet>
      -->
      <mat-card
        class="container"
        fxLayout="row wrap"
        fxLayout.xs="column"
        fxLayoutAlign="center center"
        fxLayoutGap="10px"
        fxLayoutGap.xs="0"
      >
        <a class="available-institution">
          <img
            src="/assets/institutions/{{ dataset.institution.name }}.png"
            matTooltip="{{ dataset.institution.name }}"
          />
        </a>
      </mat-card>
      <mat-divider [inset]="true"></mat-divider>
      <mat-card
        *ngIf="
          user && dataset.id !== '' && dataset.can_manage_permission === true
        "
      >
        <mat-toolbar>
          <mat-card-title>
            Dataset Team
          </mat-card-title>
        </mat-toolbar>
        <mat-list dense>
          <table
            mat-table
            [dataSource]="userPermissionsTeam$ | async"
            class="mat-elevation-z8 datasetperms"
          >
            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>EMAIL</th>
              <td mat-cell *matCellDef="let userPermission">
                <mat-label>
                  {{ userPermission.user_email }}
                </mat-label>
              </td>
            </ng-container>
            <ng-container matColumnDef="role">
              <th mat-header-cell *matHeaderCellDef>ROLE</th>
              <td mat-cell *matCellDef="let userPermission">
                {{ lookupRole(userPermission.user_role) }}
              </td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedUserpermColumns"></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                let even = even;
                columns: displayedUserpermColumns
              "
              [ngClass]="{ gray: even }"
            ></tr>
          </table>
        </mat-list>
        <button
          *ngIf="user && dataset.can_manage_permission === true"
          matTooltip="Click here to edit dataset details/permissions"
          mat-raised-button
          color="primary"
          (click)="showDataset()"
        >
          <mat-icon>security</mat-icon>
          EDIT PERMISSIONS
        </button>
      </mat-card>
      <mat-divider [inset]="true"></mat-divider>
      <mat-card
        *ngIf="
          user &&
          dataset.id !== '' &&
          dataset.url !== null &&
          dataset.url !== '' &&
          dataset.can_manage_permission === true
        "
      >
        <mat-toolbar>
          <mat-card-title>
            Published Status of current Dataset File
          </mat-card-title>
        </mat-toolbar>
        <mat-list dense>
          <mat-list>
            <mat-list-item>
              <mat-slide-toggle
                *ngIf="user && dataset.can_manage_permission === true"
                disabled
                color="primary"
                [checked]="dataset.private_data"
                (change)="
                  toggleDatasetDataPrivate(dataset, !dataset.private_data)
                "
              >
                <mat-chip
                  *ngIf="dataset.private_data"
                  matTooltip="This Resource is only visible to PI and collaborators on this dataset."
                  id="button-not-private"
                >
                  <mat-icon style="margin-right: 8px;">visibility_off</mat-icon>
                  PRIVATE
                </mat-chip>
                <mat-chip
                  *ngIf="!dataset.private_data"
                  matTooltip="This Resource is visible to all iTHRIV users."
                  id="button-private"
                >
                  <mat-icon style="margin-right: 8px;">visibility</mat-icon>
                  PUBLIC
                </mat-chip>
              </mat-slide-toggle>
            </mat-list-item>
          </mat-list>
          <mat-list
            *ngIf="
              dataset.private_data && userPermissionsCustomer$ | async;
              let userPermissionsCustomer
            "
          >
            <ng-container *ngIf="userPermissionsCustomer.length > 0">
              Note: Published current file to below individual users only:
              <table
                mat-table
                [dataSource]="userPermissionsCustomer$"
                class="mat-elevation-z8 datasetperms"
              >
                <ng-container matColumnDef="email">
                  <th mat-header-cell *matHeaderCellDef>EMAIL</th>
                  <td mat-cell *matCellDef="let userPermission">
                    <mat-label>
                      {{ userPermission.user_email }}
                    </mat-label>
                  </td>
                </ng-container>
                <ng-container matColumnDef="role">
                  <th mat-header-cell *matHeaderCellDef>ROLE</th>
                  <td mat-cell *matCellDef="let userPermission">
                    {{ lookupRole(userPermission.user_role) }}
                  </td>
                </ng-container>
                <tr
                  mat-header-row
                  *matHeaderRowDef="displayedUserpermColumns"
                ></tr>
                <tr
                  mat-row
                  *matRowDef="
                    let row;
                    let even = even;
                    columns: displayedUserpermColumns
                  "
                  [ngClass]="{ gray: even }"
                ></tr>
              </table>
            </ng-container>
          </mat-list>
          <button
            *ngIf="user && dataset.can_manage_permission === true"
            matTooltip="Click here to edit dataset details/permissions"
            mat-raised-button
            color="primary"
            (click)="showDataset()"
          >
            <mat-icon>security</mat-icon>
            EDIT PERMISSIONS
          </button>
        </mat-list>
      </mat-card>
      <mat-divider [inset]="true"></mat-divider>
      <mat-card
        *ngIf="
          user && dataset.id !== '' && dataset.can_upload_data === true
        "
      >
        <mat-toolbar>
          <mat-card-title>
            Dataset File Versions
          </mat-card-title>
        </mat-toolbar>
        <mat-list dense *ngIf="fileVersions$ | async; let fileVersions">
          <ng-container *ngIf="fileVersions.length > 0">
            <table
              mat-table
              [dataSource]="fileVersions$"
              class="mat-elevation-z8 datasetversions"
            >
              <ng-container matColumnDef="file_version">
                <th mat-header-cell *matHeaderCellDef>FILE VERSION</th>
                <td mat-cell *matCellDef="let fileVersionDetail">
                  <mat-label>
                    {{ fileVersionDetail.fileName }}
                  </mat-label>
                </td>
              </ng-container>
              <ng-container matColumnDef="creator">
                <th mat-header-cell *matHeaderCellDef>CREATOR</th>
                <td mat-cell *matCellDef="let fileVersionDetail">
                  {{ fileVersionDetail.fileCreatedBy.email }}
                </td>
              </ng-container>
              <ng-container matColumnDef="create_date_time">
                <th mat-header-cell *matHeaderCellDef>CREATE DATE/TIME</th>
                <td mat-cell *matCellDef="let fileVersionDetail">
                  {{ fileVersionDetail.fileDateCreated | date: 'MM/d/y h:mm a' }}
                </td>
              </ng-container>
              <ng-container matColumnDef="download">
                <th mat-header-cell *matHeaderCellDef>DOWNLOAD</th>
                <td mat-cell *matCellDef="let fileVersionDetail">
                  <a
                    (click)="
                      cas.downloadFile(
                        fileVersionDetail.url,
                        fileVersionDetail.fileName,
                        user
                      )
                    "
                  >
                    <button type="button" color="primary" mat-mini-fab>
                      <mat-icon
                        matTooltip="Click here to download file ({{
                          fileVersionDetail.fileName
                        }})"
                      >
                        file_download
                      </mat-icon>
                    </button>
                  </a>
                </td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="displayedFileVersionColumns"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  let even = even;
                  columns: displayedFileVersionColumns
                "
                [ngClass]="{ gray: even }"
              ></tr>
            </table>
          </ng-container>
        </mat-list>
        <div matTooltip="Click here to upload dataset file">
          <app-commons-file-upload
            *ngIf="
              user &&
              dataset.id !== '' &&
              dataset.can_upload_data === true &&
              dataset.url
            "
            color="primary"
            text="UPLOAD NEW VERSION"
            (complete)="onFileComplete($event)"
            [target]="uploadUrl()"
            [user]="user"
          ></app-commons-file-upload>
          <app-commons-file-upload
            *ngIf="
              user &&
              dataset.id !== '' &&
              dataset.can_upload_data === true &&
              !dataset.url
            "
            color="primary"
            text="UPLOAD FILE"
            (complete)="onFileComplete($event)"
            [target]="uploadUrl()"
            [user]="user"
          ></app-commons-file-upload>
        </div>
      </mat-card>
      <mat-divider [inset]="true"></mat-divider>
      <mat-card-footer>
        <button mat-raised-button color="primary" (click)="showNext()">
          <mat-icon>home</mat-icon>
          Project Home
        </button>
      </mat-card-footer>
    </div>
    <mat-card
      fxFlex.xl="25%"
      fxFlex.lg="25%"
      fxFlex.md="25%"
      fxFlex.sm="50%"
      fxFlex.xs="100%"
    >
      <mat-card-title>
        DATASET DETAILS
      </mat-card-title>
      <mat-card-content>
        <mat-chip-list *ngIf="user && dataset.can_manage_permission === true">
          <mat-chip
            *ngIf="dataset.private"
            matTooltip="This Resource is only visible to PI and collaborators on this dataset. Click here to change this setting."
            (click)="toggleDatasetPrivate(dataset, !dataset.private)"
            id="button-not-private"
          >
            <mat-icon style="margin-right: 8px;">visibility_off</mat-icon>
            PRIVATE
          </mat-chip>
          <mat-chip
            *ngIf="!dataset.private"
            matTooltip="This Resource is visible to all iTHRIV users. Click to restrict it to just dataset PI and collaborators on this dataset."
            (click)="toggleDatasetPrivate(dataset, !dataset.private)"
            id="button-private"
          >
            <mat-icon style="margin-right: 8px;">visibility</mat-icon>
            PUBLIC
          </mat-chip>
        </mat-chip-list>
        <mat-list dense>
          <mat-list-item>
            <h4 mat-line>Dataset Type:</h4>
            <p mat-line>{{ dataset.dataset_type }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>HIPAA Identifier(s):</h4>
            <p mat-line>{{ dataset.identifiers_hipaa }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Home Institution:</h4>
            <p mat-line>{{ dataset.institution.name }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Other Sensitive Data:</h4>
            <p mat-line>{{ dataset.other_sensitive_data }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Modified Date/Time:</h4>
            <p mat-line>{{ dataset.last_modified | date: 'MM/d/y h:mm a' }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Variable Measured:</h4>
            <p mat-line>{{ dataset.variable_measured }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>License:</h4>
            <p mat-line>{{ dataset.license }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Spatial Coverage Address:</h4>
            <p mat-line>{{ dataset.spatial_coverage_address }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Study IRB Number:</h4>
            <p mat-line>{{ dataset.study_irb_number }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>Link to External Dataset:</h4>
            <p mat-line>{{ dataset.link_to_external_dataset }}</p>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line></h4>
          </mat-list-item>
          <mat-list-item>
            <h4 mat-line>KEYWORDS:</h4>
            <mat-chip-list mat-line>
              <mat-chip *ngFor="let keyword of keywords()">
                {{ keyword }}
              </mat-chip>
            </mat-chip-list>
          </mat-list-item>
        </mat-list>
      </mat-card-content>
      <mat-card-actions> </mat-card-actions>
    </mat-card>
  </div>
</div>
<div *ngIf="!dataset">
  <mat-progress-spinner></mat-progress-spinner>
</div>
