<div
  *ngIf="dataset"
  fxLayout="row"
  fxLayout.xs="column"
  fxLayoutWrap
  fxLayoutGap="1em"
  fxLayoutAlign="center"
>
  <div
    fxFlex.xl="75%"
    fxFlex.lg="75%"
    fxFlex.md="67%"
    fxFlex.sm="50%"
    fxFlex.xs="100%"
  >
    <mat-card>
      <mat-card-content>
        <mat-toolbar>
          <button
            *ngIf="user && dataset.can_update_meta === true"
            matTooltip="Click here to edit dataset details/permissions"
            mat-raised-button
            color="warn"
            (click)="showDataset()"
          >
            <mat-icon>
              edit
            </mat-icon>
            EDIT DATASET DETAILS
          </button>
          <span class="ithriv-spacer"></span>
          <div matTooltip="Click here to upload latest dataset file">
            <app-commons-file-upload
              *ngIf="
                user && dataset.id !== '' && dataset.can_upload_data === true
              "
              (complete)="onFileComplete($event)"
              [target]="uploadUrl()"
              [user]="user"
              text="UPLOAD FILE"
              color="primary"
            ></app-commons-file-upload>
          </div>
          <a
            *ngIf="
              (!dataset.private || user) &&
              dataset.url !== '' &&
              dataset.can_download_data === true
            "
            (click)="cas.downloadFile(dataset.url, dataset.filename, user)"
          >
            <button type="button" mat-raised-button color="primary">
              <mat-icon
                matTooltip="Click here to download latest dataset file ({{
                  dataset.filename
                }})"
              >
                file_download
              </mat-icon>
              DOWNLOAD FILE
            </button>
          </a>
        </mat-toolbar>
        <h4>
          <markdown [data]="dataset.description"></markdown>
        </h4>
      </mat-card-content>
    </mat-card>
    <mat-card
      class="container"
      fxLayout="row wrap"
      fxLayout.xs="column"
      fxLayoutAlign="center center"
      fxLayoutGap="10px"
      fxLayoutGap.xs="0"
    >
      <a class="available-institution">
        <img
          src="/assets/institutions/{{ dataset.institution.name }}.png"
          matTooltip="{{ dataset.institution.name }}"
        />
      </a>
    </mat-card>
    <mat-divider [inset]="true"></mat-divider>
    <mat-card
      *ngIf="
        user && dataset.id !== '' && dataset.can_manage_permission === true
      "
    >
      <mat-toolbar>
        <mat-card-title>
          Dataset Team
        </mat-card-title>
      </mat-toolbar>
      <mat-list dense>
        <table
          mat-table
          [dataSource]="userPermissionsTeam$ | async"
          class="mat-elevation-z8 datasetperms"
        >
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef>EMAIL</th>
            <td mat-cell *matCellDef="let userPermission">
              <mat-label>
                {{ userPermission.user_email }}
              </mat-label>
            </td>
          </ng-container>
          <ng-container matColumnDef="role">
            <th mat-header-cell *matHeaderCellDef>ROLE</th>
            <td mat-cell *matCellDef="let userPermission">
              {{ lookupRole(userPermission.user_role) }}
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedUserpermColumns"></tr>
          <tr
            mat-row
            *matRowDef="
              let row;
              let even = even;
              columns: displayedUserpermColumns
            "
            [ngClass]="{ gray: even }"
          ></tr>
        </table>
      </mat-list>
      <button
        *ngIf="user && dataset.can_manage_permission === true"
        matTooltip="Click here to edit dataset details/permissions"
        mat-raised-button
        color="primary"
        (click)="showDataset()"
      >
        <mat-icon>security</mat-icon>
        EDIT PERMISSIONS
      </button>
    </mat-card>

    <mat-divider [inset]="true"></mat-divider>
    <mat-card
      *ngIf="
        user &&
        dataset.id !== '' &&
        dataset.url !== null &&
        dataset.url !== '' &&
        dataset.can_manage_permission === true
      "
    >
      <mat-toolbar>
        <mat-card-title>
          Published Status of current Dataset File
        </mat-card-title>
      </mat-toolbar>
      <mat-list dense>
        <mat-list>
          <mat-list-item>
            <mat-slide-toggle
              *ngIf="user && dataset.can_manage_permission === true"
              color="primary"
              [checked]="dataset.private_data"
              (change)="
                toggleDatasetDataPrivate(dataset, !dataset.private_data)
              "
            >
              <mat-chip
                matTooltip="This Resource is only visible to PI and collaborators on this dataset."
                id="button-not-private"
              >
                <mat-icon style="margin-right: 8px;">visibility_off</mat-icon>
                PRIVATE
              </mat-chip>
            </mat-slide-toggle>
          </mat-list-item>
          <mat-list-item>
            <mat-slide-toggle
              *ngIf="user && dataset.can_manage_permission === true"
              color="primary"
              [checked]="!dataset.private_data"
              (change)="
                toggleDatasetDataPrivate(dataset, !dataset.private_data)
              "
            >
              <mat-chip
                matTooltip="This Resource is visible to all iTHRIV users."
                id="button-private"
              >
                <mat-icon style="margin-right: 8px;">visibility</mat-icon>
                PUBLIC
              </mat-chip>
            </mat-slide-toggle>
          </mat-list-item>
        </mat-list>
        <mat-list
          *ngIf="
            dataset.private_data && userPermissionsCustomer$ | async;
            let userPermissionsCustomer
          "
        >
          <ng-container *ngIf="userPermissionsCustomer.length > 0">
            Note: Published current file to below individual users only:
            <table
              mat-table
              [dataSource]="userPermissionsCustomer$"
              class="mat-elevation-z8 datasetperms"
            >
              <ng-container matColumnDef="email">
                <th mat-header-cell *matHeaderCellDef>EMAIL</th>
                <td mat-cell *matCellDef="let userPermission">
                  <mat-label>
                    {{ userPermission.user_email }}
                  </mat-label>
                </td>
              </ng-container>
              <ng-container matColumnDef="role">
                <th mat-header-cell *matHeaderCellDef>ROLE</th>
                <td mat-cell *matCellDef="let userPermission">
                  {{ lookupRole(userPermission.user_role) }}
                </td>
              </ng-container>
              <tr
                mat-header-row
                *matHeaderRowDef="displayedUserpermColumns"
              ></tr>
              <tr
                mat-row
                *matRowDef="
                  let row;
                  let even = even;
                  columns: displayedUserpermColumns
                "
                [ngClass]="{ gray: even }"
              ></tr>
            </table>
          </ng-container>
        </mat-list>
        <button
          *ngIf="user && dataset.can_manage_permission === true"
          matTooltip="Click here to edit dataset details/permissions"
          mat-raised-button
          color="primary"
          (click)="showDataset()"
        >
          <mat-icon>security</mat-icon>
          EDIT PERMISSIONS
        </button>
      </mat-list>
    </mat-card>
    <mat-divider [inset]="true"></mat-divider>
    <mat-card
      *ngIf="
        user && dataset.id !== '' && dataset.can_manage_permission === true
      "
    >
      <mat-toolbar>
        <mat-card-title>
          Dataset File Versions
        </mat-card-title>
      </mat-toolbar>
      <mat-list dense *ngIf="fileVersions$ | async; let fileVersions">
        <ng-container *ngIf="fileVersions.length > 0">
          <table
            mat-table
            [dataSource]="fileVersions$"
            class="mat-elevation-z8 datasetversions"
          >
            <ng-container matColumnDef="file_version">
              <th mat-header-cell *matHeaderCellDef>FILE VERSION</th>
              <td mat-cell *matCellDef="let fileVersionDetail">
                <mat-label>
                  {{ fileVersionDetail.fileVersion }}
                </mat-label>
              </td>
            </ng-container>
            <ng-container matColumnDef="creator">
              <th mat-header-cell *matHeaderCellDef>CREATOR</th>
              <td mat-cell *matCellDef="let fileVersionDetail">
                {{ fileVersionDetail.fileCreatedBy.email }}
              </td>
            </ng-container>
            <ng-container matColumnDef="create_date_time">
              <th mat-header-cell *matHeaderCellDef>CREATE DATE/TIME</th>
              <td mat-cell *matCellDef="let fileVersionDetail">
                {{ fileVersionDetail.fileDateCreated | date: 'MM/d/y h:mm a' }}
              </td>
            </ng-container>
            <ng-container matColumnDef="download">
              <th mat-header-cell *matHeaderCellDef>DOWNLOAD</th>
              <td mat-cell *matCellDef="let fileVersionDetail">
                <a
                  (click)="
                    cas.downloadFile(
                      fileVersionDetail.url,
                      fileVersionDetail.fileName,
                      user
                    )
                  "
                >
                  <button type="button" color="primary" mat-mini-fab>
                    <mat-icon
                      matTooltip="Click here to download file ({{
                        fileVersionDetail.fileName
                      }})"
                    >
                      file_download
                    </mat-icon>
                  </button>
                </a>
              </td>
            </ng-container>
            <tr
              mat-header-row
              *matHeaderRowDef="displayedFileVersionColumns"
            ></tr>
            <tr
              mat-row
              *matRowDef="
                let row;
                let even = even;
                columns: displayedFileVersionColumns
              "
              [ngClass]="{ gray: even }"
            ></tr>
          </table>
        </ng-container>
      </mat-list>
      <div matTooltip="Click here to upload dataset file">
        <app-commons-file-upload
          *ngIf="
            user &&
            dataset.id !== '' &&
            dataset.can_upload_data === true &&
            dataset.url
          "
          color="primary"
          text="UPLOAD NEW VERSION"
          (complete)="onFileComplete($event)"
          [target]="uploadUrl()"
          [user]="user"
        ></app-commons-file-upload>
        <app-commons-file-upload
          *ngIf="
            user &&
            dataset.id !== '' &&
            dataset.can_upload_data === true &&
            !dataset.url
          "
          color="primary"
          text="UPLOAD FILE"
          (complete)="onFileComplete($event)"
          [target]="uploadUrl()"
          [user]="user"
        ></app-commons-file-upload>
      </div>
    </mat-card>
    <mat-divider [inset]="true"></mat-divider>
    <mat-card-footer>
      <button mat-raised-button color="primary" (click)="showNext()">
        <mat-icon>home</mat-icon>
        Project Home
      </button>
    </mat-card-footer>
  </div>
  <mat-card
    fxFlex.xl="25%"
    fxFlex.lg="25%"
    fxFlex.md="33%"
    fxFlex.sm="50%"
    fxFlex.xs="100%"
  >
    <mat-card-title>
      DATASET DETAILS
    </mat-card-title>
    <mat-card-content>
      <mat-chip-list *ngIf="user && dataset.can_manage_permission === true">
        <mat-chip
          *ngIf="dataset.private"
          matTooltip="This Resource is only visible to PI and collaborators on this dataset. Click here to change this setting."
          (click)="toggleDatasetPrivate(dataset, !dataset.private)"
          id="button-not-private"
        >
          <mat-icon style="margin-right: 8px;">visibility_off</mat-icon>
          PRIVATE
        </mat-chip>
        <mat-chip
          *ngIf="!dataset.private"
          matTooltip="This Resource is visible to all iTHRIV users. Click to restrict it to just dataset PI and collaborators on this dataset."
          (click)="toggleDatasetPrivate(dataset, !dataset.private)"
          id="button-private"
        >
          <mat-icon style="margin-right: 8px;">visibility</mat-icon>
          PUBLIC
        </mat-chip>
      </mat-chip-list>
      <mat-list dense>
        <mat-list-item>
          <h4 mat-line>HIPAA Identifier(s):</h4>
          <p mat-line>{{ dataset.identifiers_hipaa }}</p>
        </mat-list-item>
        <mat-list-item>
          <h4 mat-line>Home Institution:</h4>
          <p mat-line>{{ dataset.institution.name }}</p>
        </mat-list-item>
        <mat-list-item>
          <h4 mat-line>Other Sensitive Data:</h4>
          <p mat-line>{{ dataset.other_sensitive_data }}</p>
        </mat-list-item>
        <mat-list-item>
          <h4 mat-line>Modified Date/Time:</h4>
          <p mat-line>{{ dataset.last_modified | date: 'MM/d/y h:mm a' }}</p>
        </mat-list-item>
        <mat-list-item>
          <h4 mat-line></h4>
        </mat-list-item>
        <mat-list-item>
          <h4 mat-line>KEYWORDS:</h4>
          <mat-chip-list mat-line>
            <mat-chip *ngFor="let keyword of keywords()">
              {{ keyword }}
            </mat-chip>
          </mat-chip-list>
        </mat-list-item>
      </mat-list>
    </mat-card-content>
    <mat-card-actions> </mat-card-actions>
  </mat-card>
</div>
<div *ngIf="!dataset">
  <mat-progress-spinner></mat-progress-spinner>
</div>
